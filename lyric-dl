#!/usr/bin/env phantomjs

function load(name) {
    if (name.substr(0, 1) == '/') {
        return require(phantom.libraryPath + name)
    } else {
        return require(name)
    }
}

var system = load('system')
var fs = load('fs');
var common = load('/core/common.js')
var minimist = load('/core/minimist.js')

var loader = {
    'ntes': load('/core/downloader/ntes.js'),
    'qq': load('/core/downloader/qq.js'),
}

var commands_list = [ 'url', 'server', 'search' ]
var commands = {}

for (var i in commands_list) {
    var name = commands_list[i]
    commands[name] = require(phantom.libraryPath + '/command/' + name + '.js')
}


commands.help = { 'handler' : function (opt) {
    console.log("\
Usage: lyric-dl [cmd [arg [arg ...]]] [OPTIONS]\n\
\n\
GLOBAL OPTIONS:\n\
    --g-quiet                   quiet mode\n\
\n\
command: url [url1 [url2 [...]]] - download lyric:\n\
command: url - - form stdin  \n\
\n\
    SUPPORT URL: \n\
    * ntes (cloudmusic) : http://music.163.com/#/m/song?id=<ID> \n\
    * qq (qqmusic) : https://y.qq.com/portal/song/<ID>.html \n\
\n\
    OPTIONS: \n\
    -o --output=<file>          name of output file, if translate lyric exists, named: <file>.tr\n\
    -d --dir=<directory>        name of output directory\n\
    -O --out-format=<format>    output file in given format: <format>=[lrc, json]\n\
\n\
command: search [search_name] - \n\
\n\
    SUPPORT SROUCE: \n\
    * ntes \n\
\n\
    OPTIONS: \n\
    -a --all                    print all information\n\
    -i --index                  print index\n\
    -u --url                    print url\n\
    -t --title                  print title\n\
    -s --singler                print singler\n\
    -b --album                  print album\n\
    --separator=<string>        set separator string (default: <space>)\n\
\n\
command: server - launch http service:\n\
\n\
    SUPPORT ACTION: \n\
    * id : request lyric info - http://localhost:8080/?act=id&id=<song_id>&s=<source_type> \n\
\n\
    OPTIONS: \n\
    -h --host=<host>            bind address (default: 127.0.0.1)\n\
    -p --port=<format>          bind port (default: 8080)\n\
\n\
samples: lyric-dl url <URL> -o download\n\
\n\
GET MORE : https://github.com/frimin/lyric-dl\
")
    phantom.exit(0)
}}


var args = minimist.parse(system.args)

var cmd = args['_'][1]

if (args['help']) {
    cmd = 'help'
}

// handle global options

if (args['g-quiet']) {
    common.setLogVisible(false)
}

if (cmd != 'help' && args['_'].length < 2) {
    console.log("nothing to do")
    phantom.exit(2)
}

var f = commands[cmd].handler

if (f) {
    f(args)
} else {
    common.errorExit("unknown command : " + args['_'][1])
}
